name: Deploy to Kubernetes

on:
  workflow_run:
    workflows: ["Build"]  # Имя workflow, который запускает этот
    types:
      - completed

jobs:
  deploy:
    runs-on: windows-latest  # Используем Windows Runner

    steps:
    # Checkout the repository
    - name: Checkout code
      uses: actions/checkout@v3

    # Update Kubernetes manifests with the new image
    - name: Update Kubernetes manifests
      run: |
        (Get-Content deployment.yaml) -replace "image:.*", "image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}" | Set-Content deployment.yaml

    # Commit updated manifests to the repository
    - name: Commit and push changes
      uses: stefanzweifel/git-auto-commit-action@v4
      with:
        commit_message: "Update Kubernetes manifests with new image ${{ secrets.REGISTRY }}/${{ secrets.IMAGE_NAME }}:${{ github.sha }}"
        branch: main

    # Шаг 4: Используем уже существующий kubeconfig
    - name: Configure Kubernetes credentials from local kubeconfig
      run: |
        # Указываем путь к уже существующему файлу kubeconfig
        $env:KUBECONFIG = "C:\Users\Olegg\.kube\config"
        Write-Host "Kubeconfig is set"

    # Шаг 5: Установка kubectl
    - name: Install kubectl
      run: |
        choco install kubernetes-cli

    # Шаг 6: Применение Kubernetes манифестов через kubectl
    - name: Deploy to Kubernetes
      run: |
        kubectl apply -f deployment.yaml


