name: Deploy to Kubernetes via Argo CD

on:
  workflow_run:
    workflows: ["Build"]  # Имя workflow, который запускает этот
    types:
      - completed

jobs:
  deploy:
    runs-on: windows-latest  # Используем Windows Runner

    steps:
    # Checkout the repository
    - name: Checkout code
      uses: actions/checkout@v3

    # Update Kubernetes manifests with the new image
    - name: Update Kubernetes manifests
      run: |
        (Get-Content deployment.yaml) -replace "image:.*", "image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}" | Set-Content deployment.yaml

    # Commit updated manifests to the repository
    - name: Commit and push changes
      uses: stefanzweifel/git-auto-commit-action@v4
      with:
        commit_message: "Update Kubernetes manifests with new image ${{ secrets.REGISTRY }}/${{ secrets.IMAGE_NAME }}:${{ github.sha }}"
        branch: main

    # Шаг 4: Настройка kubeconfig для подключения к Kubernetes
    #- name: Configure Kubernetes credentials
     # run: |
    #  Извлекаем kubeconfig из секрета GitHub и сохраняем его в нужное место
       # $kubeconfig = ${{ secrets.KUBERNETES_CONFIG }}
       # $kubeconfig | Out-File -FilePath "C:\\Users\Olegg\.kube\config" -Force

    # Шаг 5: Применение Kubernetes манифестов через kubectl
    - name: Deploy to Kubernetes
      run: |
        kubectl apply -f deployment.yaml

