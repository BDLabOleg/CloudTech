name: Deploy to Kubernetes via Argo CD

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: windows-latest  # Используем Windows Runner

    steps:
    # Checkout the repository
    - name: Checkout code
      uses: actions/checkout@v3

    # Update Kubernetes manifests with the new image
    - name: Update Kubernetes manifests
      run: |
        (Get-Content deployment.yaml) -replace "image:.*", "image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}" | Set-Content deployment.yaml

    # Commit updated manifests to the repository
    - name: Commit and push changes
      uses: stefanzweifel/git-auto-commit-action@v4
      with:
        commit_message: "Update Kubernetes manifests with new image ${{ secrets.REGISTRY }}/${{ secrets.IMAGE_NAME }}:${{ github.sha }}"
        branch: main

    # Trigger Argo CD sync to deploy changes
    - name: Trigger Argo CD sync
      shell: pwsh
      run: |
        Invoke-RestMethod -Uri "https://argo-cd-server/api/v1/applications/<application-name>/sync" `
          -Method POST `
          -Headers @{ Authorization = "Bearer ${{ secrets.ARGOCD_AUTH_TOKEN }}" }

